<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <script src="./resources/library/react.js"></script>
    <script src="./resources/library/react-dom.js"></script>
    <script src="./resources/library/babel.min.js" charset="UTF-8"></script>
    <link rel="stylesheet" href="./resources/css/app.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor02">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarColor02">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active"> <a class="nav-link" href="#" data-abc="true">Breaking News <span class="sr-only">(current)</span></a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-abc="true">Health</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-abc="true">Business</a> </li>
            <li class="nav-item"> <a class="nav-link" href="#" data-abc="true">Sports</a> </li>
        </ul>
    </div>

    <form onsubmit="event.preventDefault()" style="float:right;padding-top:5px;" class="form-inline my-2 my-lg-0">
        <a class="navbar-brand" href="#" data-abc="true">Techvestor</a>
        <input class="form-control mr-sm-2" type="text" placeholder="Search">
        <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
    </form>
</nav>
<div id="commentApp" class="container-fluid"></div>
<script type="text/babel">
	/*
		React JS First Application
	*/

		var ParentContainer = React.createClass({

			getInitialState	: function() {
				return {
						comments : [
							'I pledge not to be abusive in my comments!'
						]
				};
			},
			eachComment	: function(text, i) {
				return (
						<CommentComponent key={i} index={i} removeComment={this.removeComment} updateComment={this.updateComment}>
								{text}</CommentComponent>
						);
			},

			removeComment : function(index) {
				console.log('About to remove comment '+(index+1));
				var cmntArr = this.state.comments;
				cmntArr.splice(index,1);
				this.setState({comments : cmntArr});
			},

			updateComment : function(index, newText) {
				console.log('About to update comment '+(index+1));
				var cmntArr = this.state.comments;
				cmntArr[index] = newText;
				this.setState({comments : cmntArr});
			},

			addComment : function(defaultText) {
				var cmntArr = this.state.comments;
				cmntArr.push(defaultText);
				this.setState({comments : cmntArr});
			},

			render	: function() {
				return (
						<div>
						    <NewsContainer />
						    <hr/>
							<button className="btn btn-primary" onClick={this.addComment.bind(null,'New Comment')}>Add Comment</button>
							{this.state.comments.map(this.eachComment)}
						</div>
						);
			}
		});
		var CommentComponent = React.createClass({

			getInitialState	: function() {
				return {editMode : false};
			},

			render	: function() {

				if(this.state.editMode)
					return this.renderEditMode();
				else
					return this.renderNormalMode();
			},

			renderNormalMode : function() {

				return (
					<div className="hero">
						<p align="center">{this.props.children}</p>
						<button onClick={this.onEditClick} className="btn btn-warning">Edit</button>
						&nbsp;&nbsp;&nbsp;
						<button onClick={this.onRemoveClick} className="btn btn-danger">Remove</button>
						<hr/>
					</div>
				);
			},

			renderEditMode : function() {

				return (
					<div className="hero">
						<textarea ref="newText" defaultValue={this.props.children}></textarea><br/>
						<button onClick={this.onSaveClick} className="btn btn-success">Save</button>
						<hr/>
					</div>
				);
			},

			onEditClick	: function() {
				console.log("Edit button clicked!");
				this.setState({editMode:true});
			},

			onRemoveClick	: function() {
				console.log("Remove button clicked!");
				this.props.removeComment(this.props.index);

			},

			onSaveClick	: function() {
				console.log("Save button clicked!");
				console.log('Entered text is : '+this.refs.newText.value);
				this.setState({editMode:false});
				this.props.updateComment(this.props.index, this.refs.newText.value);
			}
		});

		var NewsContainer = React.createClass({

		    getInitialState : function() {
		       return {newsData: "ABC"};
		    },

		    componentDidMount() {
		        // TODO: Todo item #1
		        /* DEV: fetch("/Adamantium/top-headlines")   */
		        /* PROD: fetch("/top-headlines")   */
		        const params = new URLSearchParams(window.location.search)
                const newsType = params.has('newsTopic') ? params.get('newsTopic') : 'breaking-news';
                fetch("/Adamantium/top-headlines?newsTopic="+newsType)
                  .then( res => res.json())
                  .then(
                    (data) => {
                      this.setState({
                        newsData: data
                      });
                    },
                    (error) => {
                      console.log(error)
                    }
                  );
            },

            eachArticle: function(article) {
                return(
                    <div className="col-sm-10 col-xs-10 col-md-6 col-lg-4">
                        <span><h4>{article.title}</h4> </span>
                        <br/>
                        <img className ="img-fluid" src={article.image} />
                        <br/>
                        <p className="lead">{article.content}</p>
                        <span><a href={article.url}> <b>Continue on {article.source.name}</b></a></span>
                        <br/>
                    </div>
                );
            },

		    render: function() {
		        if (this.state.newsData === "ABC")
		            return (<div className="loader"></div>);
		        else
		            return (<div className="row">
		                        {this.state.newsData.articles.map(this.eachArticle)}
		                        <br/>
		                    </div>);
		    }
		});
		ReactDOM.render(<ParentContainer/>, document.getElementById('commentApp'));

	</script>
</body>
</html>